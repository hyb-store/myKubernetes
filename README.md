# Kubernetes

## 一、Kubernetes 概述和架构

### 1.简介

Kubernetes，首字母 K，尾字母 s，中间 8 个字母，简称 K8s。

### 2.功能

1. 自动装箱
   - 基于容器对应用运行环境的资源配置要求自动部署应用容器
2. 自我修复
   - 当容器失败时，会对容器进行重启
   - 当所部署的 Node 节点有问题时，会对容器进行重新部署和重新调度
   - 当容器未通过监控检查时，会关闭此容器直到容器正常运行时，才会对外提供服务
3. 水平扩展
   - 通过简单的命令、用户 UI 界面或基于 CPU 等资源使用情况，对应用容器进行规模扩大或规模剪裁
   - 当我们有大量的请求来临时，我们可以增加副本数量，从而达到水平扩展的效果
4. 服务发现
   - 用户不需使用额外的服务发现机制，就能够基于 Kubernetes 自身能力实现服务发现和负载均衡
5. 滚动更新
   - 可以根据应用的变化，对应用容器运行的应用，进行一次性或批量式更新
6. 版本回退
   - 可以根据应用部署情况，对应用容器运行的应用，进行历史版本即时回退
7. 密钥和配置管理
   - 在不需要重新构建镜像的情况下，可以部署和更新密钥和应用配置，类似热部署。
8. 存储编排
   - 自动实现存储系统挂载及应用，特别对有状态应用实现数据持久化非常重要
   - 存储系统可以来自于本地目录、网络存储 (NFS、Gluster、Ceph 等）、公共云存储服务
9. 批处理
   - 提供一次性任务，定时任务；满足批量数据处理和分析的场景

### 3.组件介绍

#### 3.1 组件介绍

- 一个 kubernetes 集群主要由控制节点（master）、工作节点（node）构成，每个节点上都会安装不同的组件。

- 控制节点（master）：集群的控制平面，负责集群的决策。

- - API Server：集群操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制。

- - Scheduler：负责集群资源调度，按照预定的调度策略将 Pod 调度到相应的 node 节点上。

- - ControllerManager：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展和滚动更新等。

- - Etcd：负责存储集群中各种资源对象的信息。

- 工作节点（node）：集群的数据平面，负责为容器提供运行环境。

- - Kubelet：负责维护容器的生命周期，即通过控制 Docker ，来创建、更新、销毁容器。

- - KubeProxy：负责提供集群内部的服务发现和负载均衡。

- - Docker：负责节点上容器的各种操作。

![img](images/1608888638188-86fad61e-547c-43d9-8424-1d17a0c6d5a2.jpeg)

#### 3.2 组件调用关系的应用示例

部署一个 Nginx 服务来说明 Kubernetes 系统各个组件调用关系：

① 首先需要明确，一旦 Kubernetes 环境启动之后，master 和 node 都会将自身的信息存储到etcd数据库中。

② 一个Nginx服务的安装请求首先会被发送到 master 节点上的 API Server 组件。

③ API Server 组件会调用 Scheduler 组件来决定到底应该把这个服务安装到那个 node 节点上。此时，它会从 etcd 中读取各个 node 节点的信息，然后按照一定的算法进行选择，并将结果告知 API Server 。

④ API Server 调用 Controller-Manager 去调用 Node 节点安装 Nginx 服务。

⑤ Kubelet 接收到指令后，会通知 Docker ，然后由 Docker 来启动一个 Nginx 的 Pod 。Pod 是 Kubernetes 的最小操作单元，容器必须跑在 Pod 中。

⑥ 一个 Nginx 服务就运行了，如果需要访问 Nginx ，就需要通过 kube-proxy 来对 Pod 产生访问的代理，这样，外界用户就可以访问集群中的 Nginx 服务了。

### 4.概念

- Master：集群控制节点，每个集群要求至少有一个 Master 节点来负责集群的管控。
- Node：工作负载节点，由 Master 分配容器到这些 Node 工作节点上，然后 Node 节点上的 Docker 负责容器的运行。
- Pod：Kubernetes 的最小控制单元，容器都是运行在 Pod 中的，一个 Pod 中可以有一个或多个容器。
- Controller：控制器，通过它来实现对 Pod 的管理，比如启动 Pod 、停止 Pod 、伸缩 Pod 的数量等等。
- Service：Pod 对外服务的统一入口，其下面可以维护同一类的多个 Pod 。
- Label：标签，用于对 Pod 进行分类，同一类 Pod 会拥有相同的标签。
- NameSpace：命名空间，用来隔离 Pod 的运行环境。